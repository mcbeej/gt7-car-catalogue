<head>
    
    <link rel="stylesheet" href="checklist.css">


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>


    // Load all car images and assign ids to match database
    var folder = "img/cars/";
    var makeFolder = "img/makes/";

    // Onclick() functionallity 
    function collection_update(item){
        let id_ = $(item).attr("id");
        let el = document.getElementById(id_).childNodes[0]
        el.classList.toggle("Checked");

        if (el.classList.contains("Checked")){
            localStorage.setItem(id_, 'Checked');
        }
        else {
            localStorage.removeItem(id_);
        }
    }

    // JSON data from https://ddm999.github.io/gt7info/data.json
    var legend_, used_;
    var lcd_list = [];
    var ucd_list = [];
    var make_list = ["Abarth","Alfa Romeo", "Alpine", "AMG", "Amuse", "Aston Martin", "Audi", "Autobianchi", "BAC", "BMW", "Bugatti", "Chaparral", "Chevrolet", "Chris Holstrom Concepts", "Citroen", "Daihatsu", "De Tomaso", "DMC", "Dodge", "DS AUTOMOBILES", "Eckerts Rod and Custom", "Ferrari", "Fiat","Ford", "Genesis", "Gran Turismo", "Greddy", "Honda", "Hyundai", "Infiniti", "Jaguar", "Jeep", "KTM", "Lamborghini", "Lancia", "Lexus", "Maserati", "Mazda", "McLaren", "Mercedes-Benz", "MINI", "Mitsubishi", "Nissan", "Pagani", "Peugeot", "Plymouth", "Pontiac", "Porsche", "Radical", "RE Amemiya", "Renault", "RUF", "Shelby", "Subaru", "Super Formula", "Suzuki", "Tesla", "Toyota", "TVR", "Volkswagen", "Wicked Fabrication", "Zagato"];

    $.getJSON('https://ddm999.github.io/gt7info/data.json', function(res){
        legend_ = res["legend"]["cars"];
        used_ = res["used"]["cars"];

        for (l_ of legend_){
            lcd_list.push(l_.carid)
        }  

        for (u_ of used_){
            ucd_list.push(u_.carid)
        } 
        populate_makes();
        populate_images();
    })

    function populate_makes(){

        make_list.forEach(make_id =>
            $("body").append( "<div class=manufacture id='"+make_id+"Div'>"+make_id+"</div><div class='make' id='" + make_id.replace(/ /g, '-') + "'></div>" ));

        const xhttp = new XMLHttpRequest();
        
        xhttp.onreadystatechange = function() {
            
            if (this.readyState == 4 && this.status == 200) {
                const fileList = this.responseText.split('\n'); // Split by lines
                let currentFolder = '';
    
                const filePaths = fileList
                    .map(f => { // Build correct path for each file
                        let filePath = '';
    
                        if (f) {
                            if (f[0] === '.') {
                                currentFolder = f.replace('.', '').replace(':', '/');
                            }
                            else if (f[f.length - 1] !== '/') {
                                filePath = `${location.href}${currentFolder}${f}`;
                            }
                        }
                
                        return filePath;
                    })
                    .filter(f => f); // Remove empty lines
                    
                    console.log(filePaths)
                    filePaths.map(f => { // Create and put images to the DOM
	                    if( f.match(/\.(png)$/)){
                            let imageFile = /[^/]*$/.exec(f)[0];
                            
                            const img = document.createElement('IMG');
                            make_ = imageFile.split('.')[0]
                            img.src = makeFolder+imageFile;
                            img.classList.add("brand");
                            $("#"+make_+"Div").append(img);
                                               
                    }});
                }
            };
        
            xhttp.open("GET", "makes.txt", true);
            xhttp.send();
            
        
    }
        
    function populate_images(){

        const xhttp = new XMLHttpRequest();
        
        xhttp.onreadystatechange = function() {
            
            if (this.readyState == 4 && this.status == 200) {
                const fileList = this.responseText.split('\n'); // Split by lines
                let currentFolder = '';
    
                const filePaths = fileList
                    .map(f => { // Build correct path for each file
                        let filePath = '';
    
                        if (f) {
                            if (f[0] === '.') {
                                currentFolder = f.replace('.', '').replace(':', '/');
                            }
                            else if (f[f.length - 1] !== '/') {
                                filePath = `${location.href}${currentFolder}${f}`;
                            }
                        }
                
                        return filePath;
                    })
                    .filter(f => f); // Remove empty lines
                    
                    filePaths.map(f => { // Create and put images to the DOM
	                    if( f.match(/\.(png)$/)){
                            let imageFile = /[^/]*$/.exec(f)[0];
                            let make_ = imageFile.split('.')[0].replace(/ /g, '-');
                            let id_ = imageFile.split('.')[2];
                            let tag_ = "", price_ = "", state_ = "";
                            
                            const img = document.createElement('IMG');
                            if (id_ in localStorage){
                                img.classList.add("Checked");
                            }
                            
                            $("#"+make_).append( 
                            "<div class='car' id='" + id_ + "' onclick=collection_update(this)></div>" 
                            );

                            img.src = folder+imageFile;
                            $("#"+id_).append(img);

                            if ( lcd_list.includes(String(id_))){
                                tag_ = "<div class='Legend'></div>";
                                $("#"+id_).append(tag_)

                                legend_.find( (el) => {
                                    if (el.carid == id_){
                                        price_ = "<div class='Price'>$"+el.credits.toLocaleString("en-US") +"</div>";
                                        $("#"+id_).append(price_);

                                        if(el.state == "limited"){
                                            state_ = "<div class='Limited'></div>";
                                        $("#"+id_).append(state_);
                                        }

                                        if(el.state == "soldout"){
                                            state_ = "<div class='Soldout'></div>";
                                        $("#"+id_).append(state_);
                                        }
                                    }
                                });
                            }
                            if ( ucd_list.includes( String(id_))){
                                tag_ = "<div class='Used'></div>";
                                $("#"+id_).append(tag_);

                                used_.find( (el) => {
                                    if (el.carid == id_){
                                        price_ = "<div class='Price'>$"+el.credits.toLocaleString("en-US") +"</div>";
                                        $("#"+id_).append(price_);

                                        if(el.state == "limited"){
                                            state_ = "<div class='Limited'></div>";
                                        $("#"+id_).append(state_);
                                        }

                                        if(el.state == "soldout"){
                                            state_ = "<div class='Soldout'></div>";
                                        $("#"+id_).append(state_);
                                        }
                                    }
                                    
                                });
                            }
                        
                            
                    }});
                }
            };
        
            xhttp.open("GET", "images.txt", true);
            xhttp.send();
        }

        
    
    </script>
</head>
<body>
    <div class="Header">
        <div>Legendary Car Dealership
            <div class="Legendtag"></div>
        </div>

        <div>Used Car Dealership
            <div class="Usedtag"></div>
        </div>

        <div>Limited
            <div class="Limitedtag"></div>
        </div>
        <div>Sold Out
            <div class="Soldouttag"></div>
        </div>
    </div>
</body>